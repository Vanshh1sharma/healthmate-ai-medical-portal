import { NextRequest, NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);

// Function to detect language based on text content
function detectLanguage(text: string): 'hi' | 'en' {
  // Simple language detection based on Devanagari script and common Hindi words
  const hindiPattern = /[\u0900-\u097F]/; // Devanagari script range
  const hindiWords = /\b(рдХреНрдпрд╛|рдХреИрд╕реЗ|рдХрдм|рдХрд╣рд╛рдБ|рдХреНрдпреЛрдВ|рд╣реИ|рд╣реИрдВ|рдореЗрдВ|рд╕реЗ|рдХрд╛|рдХреА|рдХреЗ|рдФрд░|рдпрд╛|рдкрд░|рджрд╡рд╛|рдмреАрдорд╛рд░реА|рд╕реНрд╡рд╛рд╕реНрдереНрдп|рдбреЙрдХреНрдЯрд░|рдорд░реАрдЬ|рдЗрд▓рд╛рдЬ|рджрд░реНрдж|рдмреБрдЦрд╛рд░|рд╕рд┐рд░рджрд░реНрдж|рдкреЗрдЯ|рдЦрд╛рдВрд╕реА|рд╕рд░реНрджреА|рдЬреБрдХрд╛рдо|рдПрд▓рд░реНрдЬреА|рд╕рдВрдХреНрд░рдордг|рд░рдХреНрддрдЪрд╛рдк|рдордзреБрдореЗрд╣|рд╣реГрджрдп|рдЧреБрд░реНрджреЗ|рд▓реАрд╡рд░|рдлреЗрдлрдбрд╝реЗ|рдЖрдВрдЦ|рдХрд╛рди|рдЧрд▓рд╛|рдирд╛рдХ|рддреНрд╡рдЪрд╛|рдмрд╛рд▓|рдирд╛рдЦреВрди|рд╣рдбреНрдбреА|рдорд╛рдВрд╕рдкреЗрд╢реА|рдирд░реНрд╡|рджрд┐рдорд╛рдЧ|рдЕрд╡рд╕рд╛рдж|рддрдирд╛рд╡|рдиреАрдВрдж|рднреВрдЦ|рд╡рдЬрди|рдореЛрдЯрд╛рдкрд╛|рдХрдордЬреЛрд░реА|рдЪрдХреНрдХрд░|рдШрдмрд░рд╛рд╣рдЯ|рд╕рд╛рдВрд╕|рдкреЗрд╢рд╛рдм|рд╢реМрдЪ|рдорд╛рд╕рд┐рдХ|рдЧрд░реНрднрд╛рд╡рд╕реНрдерд╛|рдмрдЪреНрдЪрд╛|рдмреБрдЬреБрд░реНрдЧ|рдорд╣рд┐рд▓рд╛|рдкреБрд░реБрд╖|рд░реЛрдЧ|рдЙрдкрдЪрд╛рд░|рдЬрд╛рдВрдЪ|рдЯреЗрд╕реНрдЯ|рд░рд┐рдкреЛрд░реНрдЯ|рдЕрд╕реНрдкрддрд╛рд▓|рдХреНрд▓рд┐рдирд┐рдХ|рдирд░реНрд╕|рдлрд╛рд░реНрдореЗрд╕реА|рдЧреЛрд▓реА|рдХреИрдкреНрд╕реВрд▓|рд╕рд┐рд░рдк|рдЗрдВрдЬреЗрдХреНрд╢рди|рдСрдкрд░реЗрд╢рди|рд╕рд░реНрдЬрд░реА|рдПрдХреНрд╕-рд░реЗ|рдЕрд▓реНрдЯреНрд░рд╛рд╕рд╛рдЙрдВрдб|рд╕реАрдЯреА рд╕реНрдХреИрди|рдПрдордЖрд░рдЖрдИ|рдИрд╕реАрдЬреА|рд░рдХреНрдд|рдореВрддреНрд░|рдорд▓|рдмрд▓рдЧрдо|рдереВрдХ|рдкрд╕реАрдирд╛|рдЖрдВрд╕реВ|рд▓рд╛рд░|рдмрд┐рд╕реНрддрд░|рдЖрд░рд╛рдо|рд╡реНрдпрд╛рдпрд╛рдо|рдпреЛрдЧ|рдзреНрдпрд╛рди|рдбрд╛рдЗрдЯ|рдкреЛрд╖рдг|рд╡рд┐рдЯрд╛рдорд┐рди|рдорд┐рдирд░рд▓|рдкреНрд░реЛрдЯреАрди|рдХрд╛рд░реНрдмреЛрд╣рд╛рдЗрдбреНрд░реЗрдЯ|рд╡рд╕рд╛|рдХреИрд▓реЛрд░реА|рдкрд╛рдиреА|рдЬреВрд╕|рджреВрдз|рдЪрд╛рдп|рдХреЙрдлреА|рд╢рд░рд╛рдм|рдзреВрдореНрд░рдкрд╛рди|рддрдВрдмрд╛рдХреВ|рдирд╢рд╛|рдПрдбреНрд╕|рдХреИрдВрд╕рд░|рдЯреНрдпреВрдорд░|рдЯреАрдмреА|рд╣реИрдЬрд╛|рдорд▓реЗрд░рд┐рдпрд╛|рдбреЗрдВрдЧреВ|рдЪрд┐рдХрдирдЧреБрдирд┐рдпрд╛|рдЬреАрдХрд╛|рд╕реНрд╡рд╛рдЗрди рдлреНрд▓реВ|рдХреЛрд╡рд┐рдб|рдХреЛрд░реЛрдирд╛|рд╡рд╛рдпрд░рд╕|рдмреИрдХреНрдЯреАрд░рд┐рдпрд╛|рдлрдВрдЧрд╕|рдкрд░рдЬреАрд╡реА|рдПрдВрдЯреАрдмрд╛рдпреЛрдЯрд┐рдХ|рдПрдВрдЯреАрд╡рд╛рдпрд░рд▓|рдПрдВрдЯреАрдлрдВрдЧрд▓|рдПрдВрдЯреА-рдЗрдВрдлреНрд▓реЗрдореЗрдЯрд░реА|рдкреЗрдирдХрд┐рд▓рд░|рдПрд╕рд┐рдбрд┐рдЯреА|рдЧреИрд╕|рдХрдмреНрдЬ|рджрд╕реНрдд|рдЙрд▓реНрдЯреА|рдорддрд▓реА|рднреЛрдЬрди|рдЦрд╛рдирд╛|рдкреЗрдп|рджрд╡рд╛рдИ|рдФрд╖рдзрд┐|рдЖрдпреБрд░реНрд╡реЗрдж|рд╣реЛрдореНрдпреЛрдкреИрдереА|рдПрд▓реЛрдкреИрдереА|рдпреВрдирд╛рдиреА|рдкреНрд░рд╛рдХреГрддрд┐рдХ|рд╣рд░реНрдмрд▓|рдШрд░реЗрд▓реВ|рдиреБрд╕реНрдЦрд╛|рдЙрдкрд╛рдп|рдЗрд▓рд╛рдЬ|рдмрдЪрд╛рд╡|рд░реЛрдХрдерд╛рдо|рд╕рд╛рд╡рдзрд╛рдиреА|рд╕рд▓рд╛рд╣|рд░рд╛рдп|рд╕реБрдЭрд╛рд╡|рдЬрд╛рдирдХрд╛рд░реА|рд╢рд┐рдХреНрд╖рд╛|рдЬрд╛рдЧрд░реВрдХрддрд╛|рд╕реНрд╡рдЪреНрдЫрддрд╛|рд╕рд╛рдл-рд╕рдлрд╛рдИ|рд╣рд╛рдЗрдЬреАрди|рд╕рдВрдХреНрд░рд╛рдордХ|рдЫреВрдд|рдлреИрд▓рдирд╛|рдмрдЪрдирд╛|рдмрдЪрд╛рд╡|рдкреНрд░рддрд┐рд░рдХреНрд╖рд╛|рдЗрдореНрдпреБрдирд┐рдЯреА|рдкреНрд░рддрд┐рд░реЛрдз|рдПрд▓рд░реНрдЬрд┐рдХ|рд░рд┐рдПрдХреНрд╢рди|рд╕рд╛рдЗрдб рдЗрдлреЗрдХреНрдЯ|рджреБрд╖реНрдкреНрд░рднрд╛рд╡|рдиреБрдХрд╕рд╛рди|рдлрд╛рдпрджрд╛|рд▓рд╛рдн|рд╣рд╛рдирд┐|рдЬреЛрдЦрд┐рдо|рдЦрддрд░рд╛|рдЧрдВрднреАрд░|рдорд╛рдореВрд▓реА|рд╣рд▓реНрдХрд╛|рддреАрд╡реНрд░|рдкреБрд░рд╛рдирд╛|рдирдпрд╛|рддреБрд░рдВрдд|рдзреАрд░реЗ|рдЕрдЪрд╛рдирдХ|рд▓рдВрдмреЗ рд╕рдордп|рдЫреЛрдЯреЗ рд╕рдордп|рдХреБрдЫ рджрд┐рди|рд╣рдлреНрддреЗ|рдорд╣реАрдиреЗ|рд╕рд╛рд▓|рдЬрдиреНрдо|рдореГрддреНрдпреБ|рдЬреАрд╡рди|рд╕реНрд╡рд╛рд╕реНрдереНрдп|рдмреАрдорд╛рд░реА|рд░реЛрдЧ|рд╡рд┐рдХрд╛рд░|рд╕рдорд╕реНрдпрд╛|рдкрд░реЗрд╢рд╛рдиреА|рдХрд╖реНрдЯ|рдкреАрдбрд╝рд╛|рддрдХрд▓реАрдл|рджреБрдЦ|рджрд░реНрдж|рдЪреЛрдЯ|рдШрд╛рд╡|рдЦрд░реЛрдВрдЪ|рдХрдЯ|рдлреНрд░реИрдХреНрдЪрд░|рдореЛрдЪ|рд╕реВрдЬрди|рд▓рд╛рд▓рд┐рдорд╛|рдЦреБрдЬрд▓реА|рдЬрд▓рди|рд╕реБрдиреНрдирддрд╛|рдЭреБрдирдЭреБрдиреА|рдХрдВрдкрди|рджреМрд░рд╛|рдмреЗрд╣реЛрд╢реА|рдЪрдХреНрдХрд░|рдХрдордЬреЛрд░реА|рдердХрд╛рди|рд╕реБрд╕реНрддреА|рдЖрд▓рд╕реНрдп|рд╕рдХреНрд░рд┐рдпрддрд╛|рдЪреБрд╕реНрддреА|рдлреБрд░реНрддреА|рддрд╛рдХрдд|рд╢рдХреНрддрд┐|рдКрд░реНрдЬрд╛|рдЬреЛрд╢|рдЙрддреНрд╕рд╛рд╣|рдЦреБрд╢реА|рдЧрдо|рдкрд░реЗрд╢рд╛рдиреА|рдЪрд┐рдВрддрд╛|рдбрд░|рднрдп|рдШрдмрд░рд╛рд╣рдЯ|рддрдирд╛рд╡|рдЕрд╡рд╕рд╛рдж|рдЦреБрд╢реА|рдкреНрд░рд╕рдиреНрдирддрд╛|рд╕рдВрддреБрд╖реНрдЯрд┐|рдЕрд╕рдВрддреБрд╖реНрдЯрд┐|рдЧреБрд╕реНрд╕рд╛|рдХреНрд░реЛрдз|рдЪрд┐рдбрд╝рдЪрд┐рдбрд╝рд╛рд╣рдЯ|рд╢рд╛рдВрддрд┐|рдЖрд░рд╛рдо|рд╕реБрдХреВрди|рдкрд░реЗрд╢рд╛рдиреА|рдмреЗрдЪреИрдиреА|рдЕрдзреАрд░рддрд╛|рдзреИрд░реНрдп|рд╕рдмреНрд░|рд╕рдВрдпрдо|рдирд┐рдпрдВрддреНрд░рдг|рдЕрдиреБрд╢рд╛рд╕рди|рдирд┐рдпрдо|рд╕рдордп|рджрд┐рдирдЪрд░реНрдпрд╛|рдЖрджрдд|рд╡реНрдпрд╡рд╣рд╛рд░|рдмрд░реНрддрд╛рд╡|рд╕реЛрдЪ|рд╡рд┐рдЪрд╛рд░|рдорди|рджрд┐рдорд╛рдЧ|рджрд┐рд▓|рд╣реГрджрдп|рднрд╛рд╡рдирд╛|рдПрд╣рд╕рд╛рд╕|рдЕрдиреБрднрд╡|рдорд╣рд╕реВрд╕|рд╕рдордЭ|рдЬрд╛рдирдХрд╛рд░реА|рдЬреНрдЮрд╛рди|рд╢рд┐рдХреНрд╖рд╛|рд╕реАрдЦ|рд╕рдмрдХ|рдЕрдиреБрднрд╡|рддрдЬреБрд░реНрдмрд╛|рдХреБрд╢рд▓рддрд╛|рдпреЛрдЧреНрдпрддрд╛|рдХреНрд╖рдорддрд╛|рд╢рдХреНрддрд┐|рд╕рд╛рдорд░реНрдереНрдп|рддрд╛рдХрдд|рдмрд▓|рджрдо|рд╣рд┐рдореНрдордд|рд╕рд╛рд╣рд╕|рдзреИрд░реНрдп|рд╕рдмреНрд░|рдЖрд╢рд╛|рдЙрдореНрдореАрдж|рднрд░реЛрд╕рд╛|рд╡рд┐рд╢реНрд╡рд╛рд╕|рд╢реНрд░рджреНрдзрд╛|рдЖрд╕реНрдерд╛|рдзрд░реНрдо|рдЖрдзреНрдпрд╛рддреНрдо|рдорд╛рдирд╕рд┐рдХ|рд╢рд╛рд░реАрд░рд┐рдХ|рднрд╛рд╡рдирд╛рддреНрдордХ|рд╕рд╛рдорд╛рдЬрд┐рдХ|рдкрд╛рд░рд┐рд╡рд╛рд░рд┐рдХ|рд╡реНрдпрдХреНрддрд┐рдЧрдд|рдирд┐рдЬреА|рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ|рд╕рд╛рдореБрджрд╛рдпрд┐рдХ|рд░рд╛рд╖реНрдЯреНрд░реАрдп|рдЕрдВрддрд░реНрд░рд╛рд╖реНрдЯреНрд░реАрдп|рд╡реИрд╢реНрд╡рд┐рдХ|рд╕реНрдерд╛рдиреАрдп|рдХреНрд╖реЗрддреНрд░реАрдп|рд░рд╛рдЬреНрдп|рдЬрд┐рд▓рд╛|рд╢рд╣рд░|рдЧрд╛рдВрд╡|рдШрд░|рдкрдбрд╝реЛрд╕|рд╕рдореБрджрд╛рдп|рд╕рдорд╛рдЬ|рджреЗрд╢|рджреБрдирд┐рдпрд╛|рдкреГрдереНрд╡реА|рдкреНрд░рдХреГрддрд┐|рдкрд░реНрдпрд╛рд╡рд░рдг|рд╣рд╡рд╛|рдкрд╛рдиреА|рдорд┐рдЯреНрдЯреА|рдЖрдЧ|рдЬрд▓|рд╡рд╛рдпреБ|рдкреГрдереНрд╡реА|рдЖрдХрд╛рд╢|рд╕реВрд░реНрдп|рдЪрд╛рдВрдж|рддрд╛рд░реЗ|рдЧреНрд░рд╣|рд╕реМрд░ рдордВрдбрд▓|рдмреНрд░рд╣реНрдорд╛рдВрдб|рдЬреАрд╡|рдкреНрд░рд╛рдгреА|рдкрд╢реБ|рдкрдХреНрд╖реА|рдордЫрд▓реА|рдХреАрдбрд╝реЗ|рдкреЗрдбрд╝|рдкреМрдзреЗ|рдлреВрд▓|рдлрд▓|рд╕рдмреНрдЬреА|рдЕрдирд╛рдЬ|рджрд╛рд▓|рддреЗрд▓|рдорд╕рд╛рд▓рд╛|рдирдордХ|рдЪреАрдиреА|рдорд┐рдард╛рдИ|рдЦрд╛рдирд╛|рднреЛрдЬрди|рдЖрд╣рд╛рд░|рдкреЛрд╖рдг|рд╕реНрд╡рд╛рдж|рдореАрдард╛|рдЦрдЯреНрдЯрд╛|рддреАрдЦрд╛|рдХрдбрд╝рд╡рд╛|рдирдордХреАрди|рдЧрд░реНрдо|рдардВрдбрд╛|рд╕рд░реНрдж|рдЧреБрдирдЧреБрдирд╛|рддрд╛рдЬрд╛|рдмрд╛рд╕реА|рдкреБрд░рд╛рдирд╛|рдирдпрд╛|рд╕рд╛рдл|рдЧрдВрджрд╛|рд╕реНрд╡рдЪреНрдЫ|рдЕрд╢реБрджреНрдз|рд╢реБрджреНрдз|рдорд┐рд▓рд╛рд╡рдЯреА|рдирдХрд▓реА|рдЕрд╕рд▓реА|рдкреНрд░рд╛рдХреГрддрд┐рдХ|рдХреГрддреНрд░рд┐рдо|рд░рд╛рд╕рд╛рдпрдирд┐рдХ|рдЬреИрд╡рд┐рдХ|рдЬреИрд╡рд┐рдХ|рдЕрдЬреИрд╡рд┐рдХ|рд╕рдЬреАрд╡|рдирд┐рд░реНрдЬреАрд╡|рдЪрд▓рддрд╛|рд╕реНрдерд┐рд░|рдЧрддрд┐рд╢реАрд▓|рд╕реНрдерд╛рд╡рд░|рдЬрдВрдЧрдо)\b/gi;
  
  // Check for Hindi script or common Hindi words
  if (hindiPattern.test(text) || hindiWords.test(text)) {
    return 'hi';
  }
  
  // Default to English
  return 'en';
}

export async function POST(req: NextRequest) {
  try {
    const { question, language, context = 'comprehensive_health' } = await req.json();

    if (!question || typeof question !== 'string') {
      return NextResponse.json(
        { error: 'Question is required' },
        { status: 400 }
      );
    }

    // Auto-detect language if not provided
    const detectedLanguage = language || detectLanguage(question);
    const isHindi = detectedLanguage === 'hi';
    
    const systemPrompt = isHindi
      ? `рдЖрдк HealthMate рд╣реИрдВ, рдПрдХ рдмрд╣реБрдд рд╣реА рдЕрдиреБрднрд╡реА рдФрд░ рджрдпрд╛рд▓реБ AI рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рд╣рд╛рдпрдХред рдЖрдк рд╣рд░ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рд╡рд╛рд▓реЛрдВ рдХрд╛ рдЬрд╡рд╛рдм рджреЗрддреЗ рд╣реИрдВ:

тЬЕ рдЖрдк рдЬрд╡рд╛рдм рджреЗ рд╕рдХрддреЗ рд╣реИрдВ:
- рд╕рднреА рдкреНрд░рдХрд╛рд░ рдХреА рджрд╡рд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ (рдЙрдкрдпреЛрдЧ, рдЦреБрд░рд╛рдХ, рд╕рд╛рдЗрдб рдЗрдлреЗрдХреНрдЯреНрд╕, рд╕рд╛рд╡рдзрд╛рдирд┐рдпрд╛рдВ)
- рдмреАрдорд╛рд░рд┐рдпреЛрдВ рдФрд░ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ (рд▓рдХреНрд╖рдг, рдХрд╛рд░рдг, рдмрдЪрд╛рд╡)
- рд▓рдХреНрд╖рдгреЛрдВ рдХреА рд╡реНрдпрд╛рдЦреНрдпрд╛ (рджрд░реНрдж, рдмреБрдЦрд╛рд░, рдЦрд╛рдВрд╕реА, рдкреЗрдЯ рдХреА рд╕рдорд╕реНрдпрд╛, рдорд╛рдирд╕рд┐рдХ рд╕реНрд╡рд╛рд╕реНрдереНрдп)
- рд╕реНрд╡рд╛рд╕реНрдереНрдп рдФрд░ рдЬреАрд╡рдирд╢реИрд▓реА рдХреА рд╕рд▓рд╛рд╣ (рдЖрд╣рд╛рд░, рд╡реНрдпрд╛рдпрд╛рдо, рдиреАрдВрдж, рддрдирд╛рд╡ рдкреНрд░рдмрдВрдзрди)
- рдШрд░реЗрд▓реВ рдЙрдкрдЪрд╛рд░ рдФрд░ рдкреНрд░рд╛рдХреГрддрд┐рдХ рдЙрдкрд╛рдп
- рдЪрд┐рдХрд┐рддреНрд╕рд╛ рдкрд░реАрдХреНрд╖рдг рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХреА рдЬрд╛рдирдХрд╛рд░реА
- рдорд╣рд┐рд▓рд╛рдУрдВ, рдкреБрд░реБрд╖реЛрдВ, рдмрдЪреНрдЪреЛрдВ, рдФрд░ рдмреБрдЬреБрд░реНрдЧреЛрдВ рдХреЗ рд╡рд┐рд╢реЗрд╖ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдореБрджреНрджреЗ
- рдорд╛рдирд╕рд┐рдХ рд╕реНрд╡рд╛рд╕реНрдереНрдп (рдЕрд╡рд╕рд╛рдж, рдЪрд┐рдВрддрд╛, рддрдирд╛рд╡)
- рдкреЛрд╖рдг рдФрд░ рд╡рд┐рдЯрд╛рдорд┐рди рдХреА рдХрдореА
- рддреНрд╡рдЪрд╛, рдмрд╛рд▓, рдФрд░ рд╕реМрдВрджрд░реНрдп рд╕рдВрдмрдВрдзреА рд╕рдорд╕реНрдпрд╛рдПрдВ

ЁЯОп рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд┐рд░реНрджреЗрд╢:
- рд╣рдореЗрд╢рд╛ рд╕рд╛рдл рдФрд░ рд╕рд░рд▓ рд╣рд┐рдВрджреА рдореЗрдВ рдЙрддреНрддрд░ рджреЗрдВ
- рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдФрд░ рдЙрдкрдпреЛрдЧреА рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВ
- рд╕рдордЭрд╛рдиреЗ рдореЗрдВ рд░реЛрдЧреА рдХреЗ рд╕рд╛рде рд╕рд╣рд╛рдиреБрднреВрддрд┐ рджрд┐рдЦрд╛рдПрдВ
- рдЧрдВрднреАрд░ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рддреБрд░рдВрдд рдбреЙрдХреНрдЯрд░ рд╕реЗ рдорд┐рд▓рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрдВ
- рдХрднреА рднреА рдирд┐рджрд╛рди рди рдХрд░реЗрдВ, рдХреЗрд╡рд▓ рд╢реИрдХреНрд╖рд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВ
- рдЕрдЧрд░ рдХреБрдЫ рдирд╣реАрдВ рдкрддрд╛ рддреЛ рдИрдорд╛рдирджрд╛рд░реА рд╕реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ`
      : `You are HealthMate, a highly experienced and compassionate AI health assistant. You answer all types of health-related questions:

тЬЕ You can answer about:
- All types of medicines (usage, dosage, side effects, precautions)
- Diseases and health conditions (symptoms, causes, prevention)
- Symptom explanations (pain, fever, cough, digestive issues, mental health)
- Health and lifestyle advice (diet, exercise, sleep, stress management)
- Home remedies and natural treatments
- Medical tests and report interpretations
- Women's, men's, children's, and elderly health issues
- Mental health (depression, anxiety, stress)
- Nutrition and vitamin deficiencies
- Skin, hair, and beauty-related problems

ЁЯОп Important Guidelines:
- Always respond in clear, simple English
- Provide practical and useful information
- Show empathy and understanding in explanations
- Recommend immediate medical attention for serious cases
- Never diagnose, only provide educational information
- If you don't know something, honestly admit it`;

    const userPrompt = isHindi
      ? `рд╕реНрд╡рд╛рд╕реНрдереНрдп рдкреНрд░рд╢реНрди: ${question}\n\nрдХреГрдкрдпрд╛ рдЗрд╕ рдкреНрд░рд╢реНрди рдХрд╛ рд╡рд┐рд╕реНрддреГрдд рдФрд░ рдЙрдкрдпреЛрдЧреА рдЙрддреНрддрд░ рд╣рд┐рдВрджреА рдореЗрдВ рджреЗрдВред рдЕрдЧрд░ рдпрд╣ рджрд╡рд╛, рдмреАрдорд╛рд░реА, рдпрд╛ рд▓рдХреНрд╖рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИ, рддреЛ рдкреВрд░реА рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВред`
      : `Health question: ${question}\n\nPlease provide a detailed and helpful answer in English. If it's about medicine, disease, or symptoms, give comprehensive information.`;

    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
    
    const result = await model.generateContent(`${systemPrompt}\n\n${userPrompt}`);
    const response = await result.response;
    const text = response.text();

    if (!text) {
      const fallbackMessage = isHindi
        ? 'рдорд╛рдл рдХрд░реЗрдВ, рдореИрдВ рдЕрднреА рдЖрдкрдХреА рдорджрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВред'
        : 'Sorry, I cannot help you right now. Please try again later.';
      
      return NextResponse.json({ response: fallbackMessage, detectedLanguage });
    }

    return NextResponse.json({ response: text, detectedLanguage });

  } catch (error) {
    console.error('Chatbot API error:', error);
    
    const errorMessage = 'Sorry, I encountered an error. Please try again.';
    return NextResponse.json(
      { error: errorMessage },
      { status: 500 }
    );
  }
}